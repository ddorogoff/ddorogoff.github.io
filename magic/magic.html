<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Предсказание</title>
  <style>
    :root{
      --bg1:#fff7da;
      --bg2:#fff2c0;
      --text:#111;
      --muted: rgba(17,17,17,0.62);
      --btn:#111;
      --btnText:#fff;
      --shadow: rgba(0,0,0,0.12);

      --ball1:#fff6cf;
      --ball2:#ffe57a;
      --ball3:#ffde40;
    }

    html, body { height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 20% 10%, #ffffff 0%, var(--bg1) 45%, var(--bg2) 100%);
    }

    /* СНЕГ */
    #snow {
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:0;
      pointer-events:none;
      opacity:0.9;
    }

    /* ФОН: только лёгкая ёлочка + световые пятна, без подарков */
    .bg {
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;
      opacity:0.9;
    }
    .bg svg { width:100%; height:100%; display:block; }

    .wrap{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      text-align:center;
    }

    .ui{
      width:min(560px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
    }

    .title{
      font-size: 20px;
      font-weight: 850;
      letter-spacing: 0.2px;
      margin:0;
    }
    .subtitle{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      max-width: 420px;
    }

    /* Блок со спиралью */
    .spiral-wrap{
      position:relative;
      width: 230px;
      height: 230px;
      display:grid;
      place-items:center;
      margin: 8px 0 2px;
      filter: drop-shadow(0 18px 40px var(--shadow));
    }

    /* “Шар” за спиралькой */
    .ball{
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,0.95), rgba(255,255,255,0.00) 45%),
        radial-gradient(circle at 55% 65%, var(--ball1) 0%, var(--ball2) 45%, var(--ball3) 100%);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,0.06),
        inset 0 -18px 40px rgba(0,0,0,0.10);
    }

    /* лёгкое внешнее свечение */
    .glow{
      position:absolute;
      inset:-20px;
      border-radius:999px;
      background: radial-gradient(circle at 50% 55%,
        rgba(255,255,255,0.85),
        rgba(255,255,255,0.45) 35%,
        rgba(255,255,255,0.00) 70%);
      filter: blur(12px);
      opacity: 0.85;
      pointer-events:none;
    }

    /* ВАЖНО: крутим ВЕСЬ контейнер со спиралькой (самый надёжный способ) */
    .spinner{
      position:relative;
      width: 230px;
      height: 230px;
      display:grid;
      place-items:center;

      /* для SVG-вращений иногда нужно явно */
      transform-origin: 50% 50%;
    }

    .spin .spinner{
      animation: spin 1.05s linear infinite;
    }
    .spin .glow{
      animation: pulse 1.05s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse {
      0%,100% { opacity: .75; }
      50% { opacity: 1; }
    }

    .spiral{
      width: 210px;
      height: 210px;
      display:block;
      z-index:2;

      /* чтобы у SVG точно был центр вращения, если вдруг решишь крутить именно svg */
      transform-box: fill-box;
      transform-origin: 50% 50%;
    }

    .status{
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }

    .pred{
      width:min(560px, 100%);
      font-size: 18px;
      line-height: 1.35;
      font-weight: 700;
      padding: 0 6px;
      min-height: 56px;
    }

    .btn{
      width:min(360px, 100%);
      border: 0;
      border-radius: 18px;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 850;
      background: var(--btn);
      color: var(--btnText);
      cursor:pointer;
      box-shadow: 0 16px 36px rgba(0,0,0,0.18);
      transition: transform .06s ease;
    }
    .btn:active{ transform: scale(0.99); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .note{
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-height: 720px){
      .spiral-wrap{ width: 200px; height: 200px; }
      .spinner{ width: 200px; height: 200px; }
      .spiral{ width: 180px; height: 180px; }
      .pred{ font-size: 16px; }
      .ball{ inset: 10px; }
    }
  </style>
</head>

<body>
  <canvas id="snow"></canvas>

  <div class="bg" aria-hidden="true">
    <svg viewBox="0 0 1000 700" preserveAspectRatio="none">
      <defs>
        <radialGradient id="g1" cx="20%" cy="25%" r="60%">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="0.70"/>
          <stop offset="55%" stop-color="#ffffff" stop-opacity="0.10"/>
          <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
        </radialGradient>
        <radialGradient id="g2" cx="78%" cy="35%" r="70%">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="0.50"/>
          <stop offset="60%" stop-color="#ffffff" stop-opacity="0.10"/>
          <stop offset="100%" stop-color="#ffffff" stop-opacity="0"/>
        </radialGradient>
      </defs>

      <rect x="0" y="0" width="1000" height="700" fill="url(#g1)"/>
      <rect x="0" y="0" width="1000" height="700" fill="url(#g2)"/>

      <!-- ёлка (очень лёгкая, снизу слева) -->
      <g opacity="0.18" transform="translate(120,210)">
        <path d="M180 360 L 80 520 H 280 Z" fill="#2b6b3a"/>
        <path d="M180 280 L 60 460 H 300 Z" fill="#2f7a40"/>
        <path d="M180 200 L 70 390 H 290 Z" fill="#33884a"/>
        <rect x="160" y="520" width="40" height="60" rx="10" fill="#7a4b2a"/>
        <circle cx="150" cy="330" r="9" fill="#d43f3f"/>
        <circle cx="210" cy="360" r="8" fill="#1e6bd6"/>
        <circle cx="185" cy="430" r="10" fill="#d4a21f"/>
      </g>
    </svg>
  </div>

  <div class="wrap">
    <div class="ui">
      <div>
        <h1 class="title">Предсказание на год</h1>
        <p class="subtitle">Нажми кнопку — спиралька прокрутится и покажет новый вариант.</p>
      </div>

      <div class="spiral-wrap" id="spinZone">
        <div class="glow"></div>
        <div class="ball"></div>

        <div class="spinner" aria-hidden="true">
          <svg class="spiral" viewBox="0 0 220 220">
            <path id="spiralPath"
                  d=""
                  fill="none"
                  stroke="#111"
                  stroke-width="18"
                  stroke-linecap="round"
                  stroke-linejoin="round"/>
          </svg>
        </div>
      </div>

      <div class="status" id="status">Готово</div>
      <div class="pred" id="pred">…</div>

      <button class="btn" id="btn">Получить предсказание</button>
      <div class="note" id="note"></div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

    // ====== ПРЕДСКАЗАНИЯ (вставь 300+) ======
    const PREDICTIONS = [
      "В этом году сработает простое правило: меньше шума — больше результата.",
      "Самое полезное знакомство случится случайно, но ты его не проигнорируешь.",
      "Весной появится идея, которая будет кормить тебя весь год.",
      "Тебе дадут шанс. Важно не вылизать его до идеала, а просто взять и сделать.",
      "К концу года ты удивишься, как далеко уехал на привычке доводить до конца."
    ];
    document.getElementById("note").textContent = `Вариантов: ${PREDICTIONS.length}`;

    // ====== СПИРАЛЬ (генерация path) ======
    function buildSpiralPath() {
      const cx = 110, cy = 110;
      const a = 2.0;
      const b = 3.55;
      const thetaMax = 5.35 * Math.PI;
      const step = 0.10;

      const pts = [];
      for (let t = 0.0; t <= thetaMax; t += step) {
        const r = a + b * t;
        const x = cx + r * Math.cos(t);
        const y = cy + r * Math.sin(t);
        pts.push([x, y]);
      }

      // “хвостик” как в логотипе
      const last = pts[pts.length - 1];
      pts.push([last[0] + 26, last[1] + 10]);

      let d = `M ${pts[0][0].toFixed(2)} ${pts[0][1].toFixed(2)}`;
      for (let i = 1; i < pts.length; i++) {
        d += ` L ${pts[i][0].toFixed(2)} ${pts[i][1].toFixed(2)}`;
      }
      return d;
    }
    document.getElementById("spiralPath").setAttribute("d", buildSpiralPath());

    // ====== ЛОГИКА “ПРОКРУТКИ” ======
    const btn = document.getElementById("btn");
    const pred = document.getElementById("pred");
    const status = document.getElementById("status");
    const spinZone = document.getElementById("spinZone");

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const pick = () => PREDICTIONS[Math.floor(Math.random() * PREDICTIONS.length)];

    async function spinAndShow() {
      btn.disabled = true;
      pred.textContent = "…";
      status.textContent = "Крутим спиральку…";

      spinZone.classList.add("spin");
      await sleep(900 + Math.floor(Math.random() * 800));
      spinZone.classList.remove("spin");

      pred.textContent = pick();
      status.textContent = "Готово";

      if (tg) tg.sendData(JSON.stringify({ action: "opened", ts: Date.now() }));
      btn.disabled = false;
    }
    btn.addEventListener("click", spinAndShow);

    // ====== СНЕГ (canvas) ======
    const canvas = document.getElementById("snow");
    const ctx = canvas.getContext("2d");
    let w = 0, h = 0, dpr = 1;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      w = Math.floor(window.innerWidth);
      h = Math.floor(window.innerHeight);
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resize);
    resize();

    const rand = (min, max) => Math.random() * (max - min) + min;
    const flakes = [];
    const FLAKE_COUNT = Math.min(160, Math.floor((w*h)/12000) + 60);

    function makeFlake(){
      return {
        x: rand(0, w),
        y: rand(-h, 0),
        r: rand(1.2, 3.3),
        vx: rand(-0.25, 0.25),
        vy: rand(0.7, 1.9),
        drift: rand(0, Math.PI * 2),
        spin: rand(0.004, 0.012),
        a: rand(0.35, 0.85)
      };
    }
    for (let i=0;i<FLAKE_COUNT;i++) flakes.push(makeFlake());

    function step(){
      ctx.clearRect(0,0,w,h);

      for (const f of flakes){
        f.drift += f.spin;
        f.x += f.vx + Math.sin(f.drift) * 0.25;
        f.y += f.vy;

        ctx.globalAlpha = f.a;
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();

        ctx.globalAlpha = f.a * 0.22;
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r * 2.2, 0, Math.PI*2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();

        if (f.y - f.r > h){
          f.x = rand(0, w);
          f.y = rand(-40, -10);
          f.vy = rand(0.7, 1.9);
          f.vx = rand(-0.25, 0.25);
          f.r = rand(1.2, 3.3);
          f.a = rand(0.35, 0.85);
        }
        if (f.x < -20) f.x = w + 20;
        if (f.x > w + 20) f.x = -20;
      }

      ctx.globalAlpha = 1;
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  </script>
</body>
</html>


